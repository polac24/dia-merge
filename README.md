# dia-merge

A tool to combine multiple .dia (llvm diagnostics file) files into a single .dia file.

## Overview

`.dia` files are generated by swift and clang compilers to let the IDE know about warnings and fix-its. By default, each compilation file generates a single .dia file with an absolute path. When a build system needs (e.g. Bazel) needs to merge all individual .dia files into an aggregation, this tool combines them into a "fat" dia.

This tool supports also remapping. That might be useful in builds distribution where machines do not share the same absolute paths `dia-merge` supports `-remap` flag(s) which `<replacement_fix>=<substitute>`.

### DIA file

DIA file is a bitcode formatted file that can be inspected with LLVM's bc-analyzer tool.  

## Example

If a project has source root `/source_root/`, on a producer side call:


```
dia-merge -r `^/source_root/=./` -output /SomeDerivedData/Example/Build/Intermediates.noindex/Example.build/Debug-iphonesimulator/Example.build/Objects-normal/arm64/Example.dia /SomeDerivedData/Example/Build/Intermediates.noindex/Example.build/Debug-iphonesimulator/Example.build/Objects-normal/arm64/AppDelegate.dia /SomeDerivedData/Example/Build/Intermediates.noindex/Example.build/Debug-iphonesimulator/Example.build/Objects-normal/arm64/ViewController.dia 
```

On a consumer side, where a source root is `/other_source_root/`, call:


```
dia-merge -r `^./=/other_source_root/` -output build_system/ExpectedLocation.dia  downloaded_package/Example.dia
```

## Build Instructions

To build, first download LLVM prebuilt binary from https://github.com/llvm/llvm-project/releases, e.g. https://github.com/llvm/llvm-project/releases/download/llvmorg-13.0.0/clang+llvm-13.0.0-x86_64-apple-darwin.tar.xz
So far, LLVM publishes only x86_64 architecture, so on arm64 machines, rosetta2 emulation is needed.

```sh
mkdir build
cd build
cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=x86_64 -DLLVM_DIR=#{path_to_downloaded_clang} ..
ninja
```

See [RELEASING.md](RELEASING.md) for a fat-architecture.

Or, if you prefer Xcode for building and debugging, you can replace the last 2 lines with the following:

```
cmake -G Xcode -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=x86_64 -DLLVM_DIR=#{path_to_downloaded_clang} ..
open index-import.xcodeproj
```
